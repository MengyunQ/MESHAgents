# Multi-Agent Reasoning for Cardiovascular Imaging Phenotype Analysis
**Official implementation of the MICCAI 2025 paper**  
>  Zhang W.\*, Qiao M.\*, Zang C., Niederer S., Matthews P., Bai W., Kainz B.  
> \* Equal contribution


<p align="center">
  <a href="https://link.springer.com/chapter/10.1007/978-3-032-04927-8_41"><img src="https://img.shields.io/badge/Paper-Springer-blue.svg" alt="Paper"></a>
  <a href="https://arxiv.org/pdf/2507.03460"><img src="https://img.shields.io/badge/arXiv-2507.03460-b31b1b.svg" alt="arXiv"></a>
</p>

## Overview

**MESHAgents** is a multi-agent reasoning framework designed for phenome-wide association studies (PheWAS) in cardiovascular imaging. It orchestrates a team of domain-specialized language model agents to automatically discover phenotypeâ€“factor associations through collaborative analysis and consensus building.

<p align="center">
  <img src="assets/meshagents_overview.png" alt="MESHAgents Framework" width="700"/>
</p>

## Features

- ğŸ¤ Multi-agent consensus mechanism for robust phenotype discovery  
- ğŸ§  Agent memory and tool modules for statistical reasoning  
- ğŸ’¬ Sequential discussion protocol inspired by clinical MDT panels  
- ğŸ©º Validated on UK Biobank (N=38,000+) for 9 disease phenotypes

## Project Structure

```bash
MESHAgents/
â”œâ”€â”€ assets/
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ clinical_measures_26k_collated_qced.csv
â”‚   â””â”€â”€ participant_characteristics_26k.csv
â”œâ”€â”€ logs/
â”œâ”€â”€ results/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ agents.py            # Agent definitions (Chief, LV, RV, etc.)
â”‚   â”œâ”€â”€ config.py            # Configuration settings
â”‚   â”œâ”€â”€ main.py              # Entry point
â”‚   â””â”€â”€ utils.py             # Statistical and utility functions
â”œâ”€â”€ concat_data.py
â”œâ”€â”€ environment.yml
â””â”€â”€ README.md
```

## Installation

- **Dependencies**
  ```bash
  git clone https://github.com/MengyunQ/MESHAgents.git
  cd MESHAgents
  conda env create -f environment.yml
  conda activate meshagents
  ```

- **Configure Environment Variables**
   Create a `.env` file from the example and add your OpenAI API key.
   ```bash
   cp .env.example .env
   ```
   Edit `.env`:
   ```env
   OPENAI_API_KEY=your_sk_key_here
   # Optional overrides
   # DATA_PATH=data/merged_data.csv
   # GPT_MODEL = "gpt-5-mini-2025-08-07"
   # MAX_TOKENS = 2000
   ```

## Data Preparation

- Place your raw CSV data files in the `data/` directory.
   - `clinical_measures_26k_collated_qced.csv`
   - `participant_characteristics_26k.csv`

- Run the preprocessing script to merge clinical measures with participant characteristics:
   ```bash
   python src/concat_data.py
   ```
  This will generate `data/merged_data.csv` which is used by the analysis pipeline.

## Usage

Run the main analysis pipeline:

```bash
python src/main.py
```

## Outputs

Results are saved in the `results/` directory with timestamps:

- **`analysis_results_*.json`**: Complete hierarchical analysis results.
- **`phenotype_scores_*.csv`**: Ranked importance scores for all analyzed phenotypes.
- **`[Organ]_analysis_*.json`**: Specific findings for LV, RV, LA, RA, Aorta, and Strain.
- **`gpt_analysis_*.json`**: Natural language summary and interpretation generated by the LLM.

## Citation

If you find this work useful, please cite our paper:

```bibtex
@inproceedings{qiao2025meshagents,
  title     = {Multi-Agent Reasoning for Cardiovascular Imaging Phenotype Analysis},
  author    = {Zhang, Weitong and Qiao, Mengyun and Zang, Chengqi and Niederer, Steven and Matthews, Paul and Bai, Wenjia and Kainz, Bernhard},
  booktitle = {International Conference on Medical Image Computing and Computer-Assisted Intervention (MICCAI)},
  year      = {2025}
}
```

## Acknowledgements
This work is supported by: EPSRC DeepGeM Grant (EP/W01842X/1), UKRI CDT in AI for Healthcare (EP/S023283/1), British Heart Foundation (RG/20/4/34803, NH/F/23/70013), National Institutes of Health (R01-HL152256), European Research Council (PREDICT-HF 864055, MIA-NORMAL 101083647, Deep4MI 884622), Edmond J. Safra Foundation, NIHR Senior Investigator Award, UK Dementia Research Institute

HPC resources were provided by the **Erlangen National High Performance Computing Center (NHR@FAU)** of the Friedrich-Alexander-UniversitÃ¤t Erlangen-NÃ¼rnberg (FAU).  

We also thank the UK Biobank for providing imaging data.
